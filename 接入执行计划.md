# 麻将逻辑接入执行计划

## ✅ 已完成

1. ✅ 修复 `room_info` 消息中 `state` 字段缺失问题
2. ✅ 测试验证基础架构（多客户端连接、房间管理）

## 🎯 下一步：接入真实麻将逻辑

### 阶段 1：准备原项目代码（需要先完成）

**步骤 1：获取原项目代码**

```bash
# 克隆原项目到本地
cd /Users/ouyjay/Desktop
git clone https://github.com/xiyoufang/mahjong.git mahjong-original

# 或者如果已经有原项目，找到项目路径
```

**步骤 2：分析原项目结构**

需要找到以下核心类：
- `GameEngine` - 游戏引擎
- `GameLogic` - 游戏逻辑
- `IPlayer` - 玩家接口
- `AIPlayer` - AI 玩家
- `AIEngine` - AI 引擎
- `GameCmd` - 游戏命令
- `FvMask` - 其他工具类

### 阶段 2：复制核心类到服务器

**目标目录**：`server/src/game/`

需要复制的文件：
1. `GameEngine.h/.cpp`
2. `GameLogic.h/.cpp`
3. `IPlayer.h`
4. `AIPlayer.h/.cpp`
5. `AIEngine.h/.cpp`
6. `GameCmd.h`
7. `FvMask.h`（如果存在）

### 阶段 3：修改 NetPlayer 实现 IPlayer 接口

**文件**：`server/src/NetPlayer.h/.cpp`

需要实现：
- `onDrawTile(int tile)` - 收到牌时
- `onPlayTile(int tile)` - 出牌时
- `onAskAction(...)` - 询问动作时
- 其他 IPlayer 接口方法

### 阶段 4：在 Room 中集成 GameEngine

**文件**：`server/src/Room.h/.cpp`

需要：
- 添加 `GameEngine` 成员变量
- 在 `startGame()` 中创建并启动 `GameEngine`
- 实现事件监听器，将游戏事件转换为网络消息

### 阶段 5：更新 MessageHandler 处理游戏消息

**文件**：`server/src/MessageHandler.cpp`

需要：
- `handlePlayCard` - 调用 `GameEngine` 的出牌方法
- `handleChooseAction` - 调用 `GameEngine` 的动作选择方法
- 发送游戏状态更新消息

### 阶段 6：测试游戏流程

测试项：
- [ ] 4 个玩家加入房间后自动开始游戏
- [ ] 发牌功能正常
- [ ] 出牌功能正常
- [ ] 吃碰杠胡功能正常
- [ ] 游戏结算正常

---

## 📋 当前状态

- ✅ 基础架构完成
- ✅ 网络通信正常
- ✅ 房间管理正常
- ⏳ 等待获取原项目代码
- ⏳ 开始接入游戏逻辑

---

## 🚀 立即行动

**如果你已经有原项目代码**：
1. 告诉我原项目的路径
2. 我会帮你复制核心类并开始集成

**如果你还没有原项目代码**：
1. 克隆原项目：`git clone https://github.com/xiyoufang/mahjong.git`
2. 或者告诉我原项目的位置
3. 然后我们开始集成

---

## 📚 参考文档

- **详细接入指南**：`server/GAME_ENGINE_INTEGRATION.md`
- **接入检查清单**：`server/INTEGRATION_CHECKLIST.md`
- **下一步行动**：`NEXT_STEPS.md`
